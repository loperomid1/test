{% extends "base.html" %}

{% block title %}Серверы - SSH Server Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2 text-gradient">
        <i class="fas fa-list me-2"></i>Управление серверами
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group-modern me-2">
            <button type="button" class="btn btn-gradient hover-lift" onclick="validateSelectedServers()"
                    data-bs-toggle="tooltip" data-bs-placement="bottom"
                    title="Проверить доступность выбранных серверов и обновить их системную информацию">
                <i class="fas fa-sync-alt me-1"></i> Обновить выбранные
            </button>
            <button type="button" class="btn btn-cyber hover-scale" onclick="showCommandModal()"
                    data-bs-toggle="tooltip" data-bs-placement="bottom"
                    title="Выполнить произвольную команду на выбранных серверах">
                <i class="fas fa-terminal me-1"></i> Выполнить команду
            </button>
            <button type="button" class="btn btn-outline-info hover-glow" onclick="showSystemInfoModal()"
                    data-bs-toggle="tooltip" data-bs-placement="bottom"
                    title="Получить системную информацию для выбранных серверов">
                <i class="fas fa-microchip me-1"></i> Получить характеристики
            </button>
            <button type="button" class="btn btn-outline-danger cyber-text" onclick="deleteSelectedServers()"
                    data-bs-toggle="tooltip" data-bs-placement="bottom"
                    title="Удалить выбранные серверы из базы данных">
                <i class="fas fa-trash me-1"></i> Удалить выбранные
            </button>
        </div>
    </div>
</div>

<!-- Enhanced Filters Card -->
<div class="card card-tech mb-4 animate-slide-in-top">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-filter text-gradient me-2"></i>Фильтры и поиск
        </h6>
    </div>
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-2">
                <label for="status" class="form-label">
                    <i class="fas fa-heartbeat me-1"></i>Статус
                </label>
                <select name="status" id="status" class="form-select">
                    <option value="all" {% if current_status == 'all' %}selected{% endif %}>Все</option>
                    <option value="valid" {% if current_status == 'valid' %}selected{% endif %}>Доступные</option>
                    <option value="invalid" {% if current_status == 'invalid' %}selected{% endif %}>Недоступные</option>
                    <option value="unchecked" {% if current_status == 'unchecked' %}selected{% endif %}>Не проверены</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="country" class="form-label">
                    <i class="fas fa-globe me-1"></i>Страна
                </label>
                <select name="country" id="country" class="form-select">
                    <option value="all">Все страны</option>
                    {% for country in countries %}
                        <option value="{{ country }}" {% if current_country == country %}selected{% endif %}>{{ country }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="os" class="form-label">
                    <i class="fas fa-desktop me-1"></i>ОС
                </label>
                <select name="os" id="os" class="form-select">
                    <option value="all">Все ОС</option>
                    {% for os_name in os_list %}
                        <option value="{{ os_name }}" {% if current_os == os_name %}selected{% endif %}>{{ os_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="sort" class="form-label">
                    <i class="fas fa-sort me-1"></i>Сортировка
                </label>
                <select name="sort" id="sort" class="form-select">
                    <option value="host" {% if current_sort == 'host' %}selected{% endif %}>По хосту</option>
                    <option value="country" {% if current_sort == 'country' %}selected{% endif %}>По стране</option>
                    <option value="last_check" {% if current_sort == 'last_check' %}selected{% endif %}>По дате проверки</option>
                    <option value="total_memory_mb" {% if current_sort == 'total_memory_mb' %}selected{% endif %}>По памяти</option>
                    <option value="cpu_cores" {% if current_sort == 'cpu_cores' %}selected{% endif %}>По CPU</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="order" class="form-label">
                    <i class="fas fa-arrow-up-down me-1"></i>Порядок
                </label>
                <select name="order" id="order" class="form-select">
                    <option value="asc" {% if current_order == 'asc' %}selected{% endif %}>По возрастанию</option>
                    <option value="desc" {% if current_order == 'desc' %}selected{% endif %}>По убыванию</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="search" class="form-label">
                    <i class="fas fa-search me-1"></i>Поиск
                </label>
                <input type="text" name="search" id="search" class="form-control" placeholder="Хост..." value="{{ current_search }}">
            </div>
            <div class="col-12">
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-gradient hover-lift">
                        <i class="fas fa-search me-1"></i> Применить фильтры
                    </button>
                    <a href="{{ url_for('servers') }}" class="btn btn-outline-secondary hover-scale">
                        <i class="fas fa-times me-1"></i> Сбросить
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Server Count and Pagination Info -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-3">
        <span class="text-muted">
            <i class="fas fa-server me-1"></i>
            Показано <strong>{{ servers.items|length }}</strong> из <strong>{{ servers.total }}</strong> серверов
            {% if servers.pages > 1 %}
                (страница {{ servers.page }} из {{ servers.pages }})
            {% endif %}
        </span>
        
        {% if servers.items|length > 0 %}
        <div class="form-check">
            <input type="checkbox" id="selectAll" onchange="toggleAllServers()" class="form-check-input">
            <label for="selectAll" class="form-check-label small text-muted">
                Выбрать все на странице
            </label>
        </div>
        {% endif %}
    </div>
    
    <div class="btn-group btn-group-sm">
        <a href="{{ url_for('servers', per_page=25) }}" 
           class="btn btn-outline-secondary {% if request.args.get('per_page', '50') == '25' %}active{% endif %}">25</a>
        <a href="{{ url_for('servers', per_page=50) }}" 
           class="btn btn-outline-secondary {% if request.args.get('per_page', '50') == '50' %}active{% endif %}">50</a>
        <a href="{{ url_for('servers', per_page=100) }}" 
           class="btn btn-outline-secondary {% if request.args.get('per_page', '50') == '100' %}active{% endif %}">100</a>
    </div>
</div>

{% if servers.items %}
<!-- Modern Servers Table -->
<div class="card card-tech animate-slide-in-bottom">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th width="40">
                            <i class="fas fa-check-square text-muted"></i>
                        </th>
                        <th>
                            <i class="fas fa-server me-1 text-primary"></i>Сервер
                        </th>
                        <th>
                            <i class="fas fa-map-marker-alt me-1 text-info"></i>Местоположение
                        </th>
                        <th>
                            <i class="fas fa-heartbeat me-1 text-success"></i>Статус
                        </th>
                        <th>
                            <i class="fas fa-microchip me-1 text-warning"></i>Система
                        </th>
                        <th>
                            <i class="fas fa-clock me-1 text-muted"></i>Последняя проверка
                        </th>
                        <th>
                            <i class="fas fa-cogs me-1"></i>Действия
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for server in servers.items %}
                    <tr class="server-item animate-fade-in delay-{{ loop.index }}00">
                        <td>
                            <input type="checkbox" name="server_ids" value="{{ server.id }}" class="form-check-input">
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="cyber-border rounded p-2">
                                        <i class="fas fa-server text-primary"></i>
                                    </div>
                                </div>
                                <div>
                                    <strong class="cyber-text">{{ server.host }}</strong>
                                    <small class="d-block text-muted">
                                        <i class="fas fa-user me-1"></i>{{ server.username }}@{{ server.host }}:{{ server.port }}
                                    </small>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if server.country %}
                                <div>
                                    <span class="badge badge-primary">
                                        <i class="fas fa-flag me-1"></i>{{ server.country }}
                                    </span>
                                    {% if server.city %}
                                        <br><small class="text-muted">
                                            <i class="fas fa-city me-1"></i>{{ server.city }}
                                        </small>
                                    {% endif %}
                                </div>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if server.is_valid is none %}
                                <span class="status-indicator status-unchecked">
                                    <i class="fas fa-question-circle"></i>
                                    Не проверен
                                </span>
                            {% elif server.is_valid %}
                                <span class="status-indicator status-valid status-online">
                                    <i class="fas fa-check-circle"></i>
                                    Доступен
                                </span>
                            {% else %}
                                <span class="status-indicator status-invalid status-error">
                                    <i class="fas fa-times-circle"></i>
                                    Недоступен
                                </span>
                                {% if server.last_error %}
                                    <br><small class="text-danger">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        {{ server.last_error[:50] }}{% if server.last_error|length > 50 %}...{% endif %}
                                    </small>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td>
                            {% if server.os_info or server.total_memory_mb or server.cpu_cores %}
                                <div class="small">
                                    {% if server.os_short_name %}
                                        <span class="badge bg-secondary mb-1">
                                            <i class="fas fa-desktop me-1"></i>{{ server.os_short_name }}
                                        </span>
                                    {% endif %}
                                    
                                    {% if server.cpu_cores %}
                                        <br><span class="text-muted">
                                            <i class="fas fa-microchip me-1"></i>{{ server.cpu_cores }} cores
                                        </span>
                                    {% endif %}
                                    
                                    {% if server.total_memory_gb %}
                                        <br><span class="text-muted">
                                            <i class="fas fa-memory me-1"></i>{{ server.total_memory_gb }}GB RAM
                                        </span>
                                    {% endif %}
                                </div>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if server.last_check %}
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>
                                    {{ server.last_check.strftime('%d.%m.%Y') }}
                                    <br>
                                    <i class="fas fa-clock me-1"></i>
                                    {{ server.last_check.strftime('%H:%M') }}
                                </small>
                            {% else %}
                                <small class="text-muted">
                                    <i class="fas fa-question me-1"></i>Никогда
                                </small>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group-modern">
                                <button class="btn btn-sm btn-outline-primary hover-lift" 
                                        onclick="validateServers([{{ server.id }}])"
                                        data-bs-toggle="tooltip" title="Проверить сервер">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success hover-scale" 
                                        onclick="executeCommandForServer({{ server.id }})"
                                        data-bs-toggle="tooltip" title="Выполнить команду">
                                    <i class="fas fa-terminal"></i>
                                </button>
                                <a href="{{ url_for('server_detail', server_id=server.id) }}" 
                                   class="btn btn-sm btn-outline-info hover-glow"
                                   data-bs-toggle="tooltip" title="Подробная информация">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger cyber-text" 
                                        onclick="deleteServer({{ server.id }})"
                                        data-bs-toggle="tooltip" title="Удалить сервер">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Enhanced Pagination -->
{% if servers.pages > 1 %}
<nav aria-label="Навигация по страницам" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if servers.has_prev %}
            <li class="page-item">
                <a class="page-link hover-lift" href="{{ url_for('servers', page=servers.prev_num, 
                                                    status=request.args.get('status', 'all'),
                                                    country=request.args.get('country', 'all'),
                                                    os=request.args.get('os', 'all'),
                                                    search=request.args.get('search', ''),
                                                    sort=request.args.get('sort', 'host'),
                                                    order=request.args.get('order', 'asc'),
                                                    per_page=request.args.get('per_page', '50')) }}">
                    <i class="fas fa-chevron-left me-1"></i> Предыдущая
                </a>
            </li>
        {% endif %}
        
        {% for page_num in servers.iter_pages() %}
            {% if page_num %}
                {% if page_num != servers.page %}
                    <li class="page-item">
                        <a class="page-link hover-scale" href="{{ url_for('servers', page=page_num,
                                                            status=request.args.get('status', 'all'),
                                                            country=request.args.get('country', 'all'),
                                                            os=request.args.get('os', 'all'),
                                                            search=request.args.get('search', ''),
                                                            sort=request.args.get('sort', 'host'),
                                                            order=request.args.get('order', 'asc'),
                                                            per_page=request.args.get('per_page', '50')) }}">{{ page_num }}</a>
                    </li>
                {% else %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                {% endif %}
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if servers.has_next %}
            <li class="page-item">
                <a class="page-link hover-lift" href="{{ url_for('servers', page=servers.next_num,
                                                    status=request.args.get('status', 'all'),
                                                    country=request.args.get('country', 'all'),
                                                    os=request.args.get('os', 'all'),
                                                    search=request.args.get('search', ''),
                                                    sort=request.args.get('sort', 'host'),
                                                    order=request.args.get('order', 'asc'),
                                                    per_page=request.args.get('per_page', '50')) }}">
                    Следующая <i class="fas fa-chevron-right ms-1"></i>
                </a>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<!-- Empty State -->
<div class="card card-tech text-center py-5">
    <div class="card-body">
        <div class="hologram-effect mb-4">
            <i class="fas fa-search fa-4x text-muted"></i>
        </div>
        <h5 class="text-muted mb-3">Серверы не найдены</h5>
        <p class="text-muted mb-4">Попробуйте изменить фильтры поиска или загрузить новые серверы</p>
        <a href="{{ url_for('upload_servers') }}" class="btn btn-gradient btn-lg hover-lift">
            <i class="fas fa-cloud-upload-alt me-2"></i>Загрузить серверы
        </a>
    </div>
</div>
{% endif %}

<!-- Enhanced Command Modal -->
<div class="modal fade" id="commandModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-gradient">
                    <i class="fas fa-terminal me-2"></i>Выполнить команду
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="commandForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="commandThreads" class="form-label">
                                <i class="fas fa-layer-group me-1"></i>Потоков
                            </label>
                            <input type="range" class="form-range" min="1" max="50" value="10" id="commandThreads">
                            <div class="text-center">
                                <span class="badge badge-primary" id="commandThreadsValue">10</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="commandTimeout" class="form-label">
                                <i class="fas fa-clock me-1"></i>Таймаут (сек)
                            </label>
                            <input type="range" class="form-range" min="5" max="60" value="10" id="commandTimeout">
                            <div class="text-center">
                                <span class="badge badge-primary" id="commandTimeoutValue">10с</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="commandText" class="form-label">
                            <i class="fas fa-code me-1"></i>Команда
                        </label>
                        <textarea class="form-control" id="commandText" rows="3" 
                                  placeholder="Введите команду для выполнения..."
                                  style="font-family: var(--font-family-mono);"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-star me-1"></i>Предустановленные команды
                        </label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-outline-secondary btn-sm hover-lift" 
                                            onclick="setCommand('uname -a')">
                                        <i class="fas fa-info-circle me-1"></i>Информация о системе
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm hover-lift" 
                                            onclick="setCommand('free -h')">
                                        <i class="fas fa-memory me-1"></i>Использование памяти
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm hover-lift" 
                                            onclick="setCommand('df -h')">
                                        <i class="fas fa-hdd me-1"></i>Использование диска
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-outline-secondary btn-sm hover-lift" 
                                            onclick="setCommand('ps aux | head -10')">
                                        <i class="fas fa-list me-1"></i>Процессы
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm hover-lift" 
                                            onclick="setCommand('uptime')">
                                        <i class="fas fa-clock me-1"></i>Время работы
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm hover-lift" 
                                            onclick="setCommand('whoami')">
                                        <i class="fas fa-user me-1"></i>Текущий пользователь
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-gradient" onclick="executeModalCommand()">
                    <i class="fas fa-play me-1"></i>Выполнить
                </button>
            </div>
        </div>
    </div>
</div>

<!-- System Info Modal -->
<div class="modal fade" id="systemInfoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-gradient">
                    <i class="fas fa-microchip me-2"></i>Получить системную информацию
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="sysInfoThreads" class="form-label">
                            <i class="fas fa-layer-group me-1"></i>Потоков
                        </label>
                        <input type="range" class="form-range" min="1" max="30" value="10" id="sysInfoThreads">
                        <div class="text-center">
                            <span class="badge badge-primary" id="sysInfoThreadsValue">10</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="sysInfoTimeout" class="form-label">
                            <i class="fas fa-clock me-1"></i>Таймаут (сек)
                        </label>
                        <input type="range" class="form-range" min="10" max="60" value="15" id="sysInfoTimeout">
                        <div class="text-center">
                            <span class="badge badge-primary" id="sysInfoTimeoutValue">15с</span>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <h6 class="alert-heading">
                        <i class="fas fa-download me-1"></i>Будет получено:
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="mb-0 small">
                                <li>Операционная система</li>
                                <li>Процессор и ядра</li>
                                <li>Оперативная память</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="mb-0 small">
                                <li>Дисковое пространство</li>
                                <li>Время работы системы</li>
                                <li>Архитектура и ядро</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-gradient" onclick="executeSystemInfoModal()">
                    <i class="fas fa-download me-1"></i>Получить информацию
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let selectedServerForCommand = null;

    // Server management functions
    function updateCommandModalValues() {
        document.getElementById('commandThreadsValue').textContent = document.getElementById('commandThreads').value;
        document.getElementById('commandTimeoutValue').textContent = document.getElementById('commandTimeout').value + 'с';
    }

    function updateSystemInfoModalValues() {
        document.getElementById('sysInfoThreadsValue').textContent = document.getElementById('sysInfoThreads').value;
        document.getElementById('sysInfoTimeoutValue').textContent = document.getElementById('sysInfoTimeout').value + 'с';
    }

    function checkCommandStatus() {
        fetch('/command_status')
        .then(response => response.json())
        .then(data => {
            if (data.running) {
                sshManager.updateProgress(data);
            } else {
                sshManager.hideProgress();
                sshManager.currentOperation = null;
                if (data.results && data.results.length > 0) {
                    showCommandResults(data.results);
                }
                sshManager.showToast('Команда выполнена', 'success');
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            sshManager.hideProgress();
            sshManager.currentOperation = null;
        });
    }

    function showCommandResults(results) {
        let html = `
            <div class="modal fade" id="resultsModal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title text-gradient">
                                <i class="fas fa-terminal me-2"></i>Результаты выполнения команды
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        `;
        
        results.forEach((result, index) => {
            html += `
                <div class="card mb-3 ${result.success ? 'border-success' : 'border-danger'} animate-fade-in delay-${index}00">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-server me-2"></i>${result.host}
                        </h6>
                        <span class="badge ${result.success ? 'badge-success' : 'bg-danger'}">
                            <i class="fas fa-${result.success ? 'check' : 'times'} me-1"></i>
                            ${result.success ? 'Успех' : 'Ошибка'}
                        </span>
                    </div>
                    <div class="card-body">
            `;
            
            if (result.output) {
                html += `
                    <div class="mb-3">
                        <strong class="text-success">
                            <i class="fas fa-terminal me-1"></i>Вывод:
                        </strong>
                        <pre class="bg-light p-3 rounded mt-2 cyber-border" style="max-height: 200px; overflow-y: auto; font-family: var(--font-family-mono);">${result.output}</pre>
                    </div>
                `;
            }
            
            if (result.error) {
                html += `
                    <div class="mb-3">
                        <strong class="text-danger">
                            <i class="fas fa-exclamation-triangle me-1"></i>Ошибка:
                        </strong>
                        <pre class="bg-danger text-white p-3 rounded mt-2" style="font-family: var(--font-family-mono);">${result.error}</pre>
                    </div>
                `;
            }
            
            if (result.processing_time) {
                html += `
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>Время выполнения: ${result.processing_time.toFixed(2)}с
                    </small>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
        });
        
        html += `
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                            <button type="button" class="btn btn-gradient" onclick="exportResults()">
                                <i class="fas fa-download me-1"></i>Экспорт результатов
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', html);
        const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
        modal.show();
        
        document.getElementById('resultsModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }

    function exportResults() {
        sshManager.showToast('Функция экспорта в разработке', 'info');
    }

    // Utility functions
    function getSelectedServers() {
        const checkboxes = document.querySelectorAll('input[name="server_ids"]:checked');
        return Array.from(checkboxes).map(cb => parseInt(cb.value));
    }

    function toggleAllServers() {
        const masterCheckbox = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('input[name="server_ids"]');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = masterCheckbox.checked;
        });
        
        updateSelectedCount();
    }

    function updateSelectedCount() {
        const selected = getSelectedServers();
        const masterCheckbox = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('input[name="server_ids"]');
        
        if (selected.length === 0) {
            masterCheckbox.indeterminate = false;
            masterCheckbox.checked = false;
        } else if (selected.length === checkboxes.length) {
            masterCheckbox.indeterminate = false;
            masterCheckbox.checked = true;
        } else {
            masterCheckbox.indeterminate = true;
        }
    }

    function validateServers(serverIds = []) {
        if (sshManager.currentOperation) {
            sshManager.showToast('Уже выполняется операция', 'warning');
            return;
        }

        sshManager.currentOperation = 'validation';
        sshManager.showProgress('Валидация серверов...');

        fetch('/validate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                server_ids: serverIds,
                threads: sshManager.currentSettings.threads,
                timeout: sshManager.currentSettings.timeout
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                sshManager.progressInterval = setInterval(checkValidationStatus, 1000);
            } else {
                sshManager.showToast('Ошибка: ' + data.error, 'error');
                sshManager.hideProgress();
                sshManager.currentOperation = null;
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            sshManager.showToast('Ошибка выполнения запроса', 'error');
            sshManager.hideProgress();
            sshManager.currentOperation = null;
        });
    }

    function checkValidationStatus() {
        fetch('/validation_status')
        .then(response => response.json())
        .then(data => {
            if (data.running) {
                sshManager.updateProgress(data);
            } else {
                sshManager.hideProgress();
                sshManager.currentOperation = null;
                sshManager.showToast('Валидация серверов завершена', 'success');
                setTimeout(() => location.reload(), 2000);
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            sshManager.hideProgress();
            sshManager.currentOperation = null;
        });
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize range inputs
        document.getElementById('commandThreads')?.addEventListener('input', updateCommandModalValues);
        document.getElementById('commandTimeout')?.addEventListener('input', updateCommandModalValues);
        document.getElementById('sysInfoThreads')?.addEventListener('input', updateSystemInfoModalValues);
        document.getElementById('sysInfoTimeout')?.addEventListener('input', updateSystemInfoModalValues);
        
        // Initialize checkbox listeners
        document.querySelectorAll('input[name="server_ids"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedCount);
        });
        
        updateSelectedCount();
        
        // Modal cleanup
        document.getElementById('commandModal')?.addEventListener('hidden.bs.modal', function() {
            selectedServerForCommand = null;
            document.getElementById('commandText').value = '';
        });
        
        // Initialize tooltips for dynamically loaded content
        setTimeout(() => {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }, 100);
    });
</script>
{% endblock %} validateSelectedServers() {
        const selected = getSelectedServers();
        if (selected.length === 0) {
            sshManager.showToast('Выберите серверы для проверки', 'warning');
            return;
        }
        validateServers(selected);
    }

    function deleteSelectedServers() {
        const selected = getSelectedServers();
        if (selected.length === 0) {
            sshManager.showToast('Выберите серверы для удаления', 'warning');
            return;
        }
        
        if (confirm(`Вы уверены, что хотите удалить ${selected.length} серверов? Это действие нельзя отменить.`)) {
            Promise.all(selected.map(id => 
                fetch(`/delete_server/${id}`, {method: 'POST'})
            )).then(() => {
                sshManager.showToast(`${selected.length} серверов удалено`, 'success');
                setTimeout(() => location.reload(), 1000);
            }).catch(error => {
                console.error('Ошибка:', error);
                sshManager.showToast('Ошибка при удалении серверов', 'error');
            });
        }
    }

    function deleteServer(serverId) {
        if (confirm('Вы уверены, что хотите удалить этот сервер? Это действие нельзя отменить.')) {
            fetch(`/delete_server/${serverId}`, {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    sshManager.showToast('Сервер удален', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    sshManager.showToast('Ошибка при удалении сервера', 'error');
                }
            }).catch(error => {
                console.error('Ошибка:', error);
                sshManager.showToast('Ошибка при удалении сервера', 'error');
            });
        }
    }

    function executeCommandForServer(serverId) {
        selectedServerForCommand = serverId;
        showCommandModal();
    }

    function showCommandModal() {
        document.getElementById('commandThreads').value = sshManager.currentSettings.threads;
        document.getElementById('commandTimeout').value = sshManager.currentSettings.timeout;
        updateCommandModalValues();
        
        new bootstrap.Modal(document.getElementById('commandModal')).show();
    }

    function showSystemInfoModal() {
        document.getElementById('sysInfoThreads').value = Math.min(sshManager.currentSettings.threads, 30);
        document.getElementById('sysInfoTimeout').value = Math.max(sshManager.currentSettings.timeout, 15);
        updateSystemInfoModalValues();
        
        new bootstrap.Modal(document.getElementById('systemInfoModal')).show();
    }

    function setCommand(command) {
        document.getElementById('commandText').value = command;
    }

    function executeModalCommand() {
        const command = document.getElementById('commandText').value.trim();
        if (!command) {
            sshManager.showToast('Введите команду', 'warning');
            return;
        }

        const serverIds = selectedServerForCommand ? [selectedServerForCommand] : getSelectedServers();
        if (serverIds.length === 0) {
            sshManager.showToast('Выберите серверы', 'warning');
            return;
        }

        const threads = parseInt(document.getElementById('commandThreads').value);
        const timeout = parseInt(document.getElementById('commandTimeout').value);

        bootstrap.Modal.getInstance(document.getElementById('commandModal')).hide();
        
        if (sshManager.currentOperation) {
            sshManager.showToast('Уже выполняется операция', 'warning');
            return;
        }

        sshManager.currentOperation = 'command';
        sshManager.showProgress('Выполнение команды...');

        fetch('/execute_command', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                command: command,
                server_ids: serverIds,
                threads: threads,
                timeout: timeout
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                sshManager.progressInterval = setInterval(checkCommandStatus, 1000);
            } else {
                sshManager.showToast('Ошибка: ' + data.error, 'error');
                sshManager.hideProgress();
                sshManager.currentOperation = null;
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            sshManager.showToast('Ошибка выполнения запроса', 'error');
            sshManager.hideProgress();
            sshManager.currentOperation = null;
        });
    }

    function executeSystemInfoModal() {
        const selected = getSelectedServers();
        if (selected.length === 0) {
            sshManager.showToast('Выберите серверы для получения системной информации', 'warning');
            return;
        }
        
        const threads = parseInt(document.getElementById('sysInfoThreads').value);
        const timeout = parseInt(document.getElementById('sysInfoTimeout').value);
        
        bootstrap.Modal.getInstance(document.getElementById('systemInfoModal')).hide();
        
        if (sshManager.currentOperation) {
            sshManager.showToast('Уже выполняется операция', 'warning');
            return;
        }

        sshManager.currentOperation = 'command';
        sshManager.showProgress('Получение системной информации...');

        fetch('/update_system_info', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                server_ids: selected,
                threads: threads,
                timeout: timeout
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                sshManager.progressInterval = setInterval(checkCommandStatus, 1000);
            } else {
                sshManager.showToast('Ошибка: ' + data.error, 'error');
                sshManager.hideProgress();
                sshManager.currentOperation = null;
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            sshManager.showToast('Ошибка выполнения запроса', 'error');
            sshManager.hideProgress();
            sshManager.currentOperation = null;
        });
    }

    function